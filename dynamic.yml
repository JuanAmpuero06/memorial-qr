# Configuración dinámica de Traefik
http:
  # Middlewares de Rate Limiting
  middlewares:
    # Rate limit global - 100 requests por segundo por IP
    global-ratelimit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Rate limit estricto para endpoints sensibles - 10 requests por minuto por IP
    strict-ratelimit:
      rateLimit:
        average: 10
        burst: 5
        period: 1m
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Rate limit para API general - 60 requests por minuto por IP
    api-ratelimit:
      rateLimit:
        average: 60
        burst: 20
        period: 1m
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Strip /api prefix para rutas de auth
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"

  routers:
    # Router para el Backend API
    backend-api:
      rule: "Host(`localhost`) && PathPrefix(`/api`)"
      entryPoints:
        - web
      service: backend
      middlewares:
        - api-ratelimit
        - strip-api-prefix
      priority: 10

    # Router para autenticación (login/register)
    backend-auth:
      rule: "Host(`localhost`) && (PathPrefix(`/token`) || PathPrefix(`/register`) || PathPrefix(`/api/v1/auth`))"
      entryPoints:
        - web
      service: backend
      middlewares:
        - strict-ratelimit
      priority: 10

    # Router para autenticación con prefijo /api (compatibilidad frontend)
    backend-auth-api:
      rule: "Host(`localhost`) && (Path(`/api/token`) || Path(`/api/register`))"
      entryPoints:
        - web
      service: backend
      middlewares:
        - strict-ratelimit
        - strip-api-prefix
      priority: 15

    # Router para documentación
    backend-docs:
      rule: "Host(`localhost`) && PathPrefix(`/docs`)"
      entryPoints:
        - web
      service: backend
      priority: 10

    # Router para archivos estáticos (imágenes)
    backend-static:
      rule: "Host(`localhost`) && PathPrefix(`/static`)"
      entryPoints:
        - web
      service: backend
      priority: 10

    # Router para redoc
    backend-redoc:
      rule: "Host(`localhost`) && PathPrefix(`/redoc`)"
      entryPoints:
        - web
      service: backend
      priority: 10

    # Router para openapi.json
    backend-openapi:
      rule: "Host(`localhost`) && PathPrefix(`/openapi.json`)"
      entryPoints:
        - web
      service: backend
      priority: 10

    # Router para el Frontend
    frontend:
      rule: "Host(`localhost`)"
      entryPoints:
        - web
      service: frontend
      middlewares:
        - global-ratelimit
      priority: 1

  services:
    # Servicio Backend con Load Balancing
    backend:
      loadBalancer:
        servers:
          - url: "http://backend:8000"
        healthCheck:
          path: /docs
          interval: "10s"
          timeout: "3s"

    # Servicio Frontend
    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:5173"
